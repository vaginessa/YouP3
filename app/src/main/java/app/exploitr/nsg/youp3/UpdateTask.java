package app.exploitr.nsg.youp3;

import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.AsyncTask;
import android.os.Environment;
import android.support.design.widget.Snackbar;
import android.util.Log;
import android.view.View;

import com.koushikdutta.async.future.FutureCallback;
import com.koushikdutta.ion.Ion;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.File;

class UpdateTask extends AsyncTask<Void, Void, String> {

    private final View mView;
    private JSONObject maindata;
    private JSONArray mainArray;
    private ProgressDialog dialog;
    private Context mContext;
    private String s;

    UpdateTask(Context context, View view) {
        this.mContext = context;
        this.mView = view;
    }

    @Override
    protected String doInBackground(Void... params) {

        try {
            s = Ion.with(mContext).load("https://api.github.com/repos/exploitr/youp3/releases/latest").followRedirect(true).asString().get();
        } catch (Exception e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        try {
            maindata = new JSONObject(s);
        } catch (JSONException e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        Log.v("Update", maindata.toString());
        try {
            mainArray = maindata.getJSONArray("assets");
        } catch (JSONException e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        Log.v("Update1", mainArray.toString());

        try {
            maindata = mainArray.getJSONObject(0);
        } catch (JSONException e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        Log.v("Update3", maindata.toString());

        String main = null;
        try {
            main = maindata.getString("browser_download_url");
        } catch (JSONException e) {
            e.printStackTrace();
        }

        return main;
    }

    @Override
    protected void onPostExecute(String link) {
        super.onPostExecute(link);

        dialog = new ProgressDialog(mContext);
        dialog.setIndeterminate(false);
        dialog.setMessage("Downloading Package - Please Wait");
        dialog.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL);
        dialog.setCancelable(false);
        dialog.show();
        final Long x = System.currentTimeMillis();
        System.out.println("Link :" + link);
        Ion.with(mContext)
                .load(link)
                .progressDialog(dialog)
                .followRedirect(true)
                .write(new File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS).getPath() + "/YouP3" + x + ".apk"))
                .setCallback(new FutureCallback<File>() {
                    @Override
                    public void onCompleted(Exception e, File file) {
                        dialog.dismiss();
                        if (file != null) {
                            Uri path = Uri.fromFile(file);
                            Intent intent = new Intent(Intent.ACTION_VIEW);
                            intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
                            intent.setDataAndType(path, "application/vnd.android.package-archive");
                            mContext.startActivity(intent);
                        } else {
                            Snackbar.make(mView, "Download Error", Snackbar.LENGTH_LONG).show();
                        }
                    }
                });
    }
}
