package app.exploitr.nsg.youp3;

import android.content.Context;
import android.content.DialogInterface;
import android.os.AsyncTask;
import android.support.v7.app.AlertDialog;
import android.view.View;

import com.koushikdutta.ion.Ion;


class UpdateTaskChecker extends AsyncTask<Void, Void, Boolean> {

    private final View mView;
    private Context context;
    private final static Integer thisId = 1;
    private String s;
    private Integer remoteId;

    UpdateTaskChecker(Context mContext, View view) {
        this.context = mContext;
        this.mView = view;
    }

    @Override
    protected Boolean doInBackground(Void... params) {

        try {
            Thread.sleep(15000);
        } catch (InterruptedException e) {
            e.printStackTrace();
            e.getSuppressed();
        }

        try {
            s = Ion.with(context).load("https://raw.githubusercontent.com/ExploiTR/YouP3/master/version.txt").followRedirect(true).asString().get();
        } catch (Exception e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        try {
            remoteId = Integer.parseInt(s.replaceAll("[^0123456789]", ""));
            System.out.println("REMOTEIDINT" + " " + remoteId);
        } catch (Exception e) {
            e.printStackTrace();
            e.getSuppressed();
        }
        return remoteId > thisId;
    }

    @Override
    protected void onPostExecute(Boolean aBoolean) {
        super.onPostExecute(aBoolean);
        AlertDialog.Builder alertDialog = new AlertDialog.Builder(context);
        alertDialog.setTitle("Update Available");
        alertDialog.setMessage("Update App?");
        alertDialog.setPositiveButton("Yes", new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                new UpdateTask(context, mView).execute();
            }
        });
        alertDialog.setNegativeButton("Nope", new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                dialog.dismiss();
            }
        });
        AlertDialog dialog = alertDialog.create();
        if (aBoolean) {
            dialog.show();
        }
    }
}
