package app.exploitr.nsg.youp3;

import android.content.Context;
import android.content.DialogInterface;
import android.os.AsyncTask;
import android.support.v7.app.AlertDialog;
import android.view.View;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;


class UpdateTaskChecker extends AsyncTask<Void, Void, Boolean> {

    private final View mView;
    private Context context;
    private final static Integer thisId = 2;
    private Integer remoteId;
    private HttpURLConnection connection;
    private URL url;
    private BufferedReader reader;

    UpdateTaskChecker(Context mContext, View view) {
        this.context = mContext;
        this.mView = view;
    }

    @Override
    protected Boolean doInBackground(Void... params) {
        int x = 0;

        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        try {
            url = new URL("https://raw.githubusercontent.com/ExploiTR/YouP3/master/version.txt");
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        try {
            connection = (HttpURLConnection) url.openConnection();
            connection.connect();
            System.out.println(x++);
        } catch (IOException e) {
            e.printStackTrace();
        }
        try {
            reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));
            System.out.println(x++);
        } catch (IOException e) {
            e.printStackTrace();
        }

        StringBuilder dataProcessor = new StringBuilder();
        System.out.println(x+1);
        String out = "";

        try {
            while ((out = reader.readLine()) != null) {
                dataProcessor.append(out).append("\n");
                System.out.println(x++);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        System.out.println("TEST CODE :"+dataProcessor.toString());

        try {
            remoteId = Integer.parseInt(dataProcessor.toString().replaceAll("[^0123456789]", ""));
            System.out.println("REMOTEIDINT" + " " + remoteId);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return remoteId > thisId;
    }

    @Override
    protected void onPostExecute(Boolean aBoolean) {
        super.onPostExecute(aBoolean);
        AlertDialog.Builder alertDialog = new AlertDialog.Builder(context);
        alertDialog.setTitle("Update Available");
        alertDialog.setMessage("Update App?");
        alertDialog.setPositiveButton("Yes", new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                new UpdateTask(context, mView).execute();
            }
        });
        alertDialog.setNegativeButton("Nope", new DialogInterface.OnClickListener() {
            @Override
            public void onClick(DialogInterface dialog, int which) {
                dialog.dismiss();
            }
        });
        AlertDialog dialog = alertDialog.create();
        if (aBoolean) {
            dialog.show();
        }
    }
}
